<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="description" content="FFMQ : FFMQ - full-java, light-weight, fast JMS 1.1 queuer implementation">

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>FFMQ</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
              <h1 id="project_title">FFMQ</h1>
              <h2 id="project_tagline">Light-weight & fast JMS message queuer</h2>
              <div style="position: absolute; top:40px; left: 330px"><img src="icon.gif"/></div>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">

		<h1>FFMQ Documentation</h1>
        <p>
        <i><u>Important Note</u> : in the following document, whenever you see a package or file named <b>ffmqX</b>, 
           you must replace the X by 3 or 4 depending on the FFMQ version you are using.</i>
        </p>
		<p class="contents"><b>Table of contents</b></p>
		<ul>
			<li><a href="#I">I. Installing</a><br/>
				<ul>
					<li><a href="#I_1">I.1. Prerequisites</a></li>
					<li><a href="#I_2">I.2. Server side</a><br/>
						<ul>
							<li><a href="#I_2_1">I.2.1. Unpacking the distribution</a></li>
							<li><a href="#I_2_2">I.2.2. What's inside ?</a></li>
						</ul>
					</li>
					<li><a href="#I_3">I.3. Client side</a></li>
				</ul>
			</li>
			<li><a href="#II">II. Configuring</a><br/>
				<ul>
					<li><a href="#II_1">II.1. Server side</a><br/>
						<ul>
							<li><a href="#II_1_1">II.1.1. Destination auto-creation</a></li>
							<li><a href="#II_1_2">II.1.2. Security</a></li>
							<li><a href="#II_1_3">II.1.3. Templates</a></li>
							<li><a href="#II_1_4">II.1.4. Descriptors</a></li>
							<li><a href="#II_1_5">II.1.5. Command-line utility</a></li>
						</ul>
					</li>
					<li><a href="#II_2">II.2. Client side</a><br/>
						<ul>
							<li><a href="#II_2_1">II.2.1. Client properties</a></li>
							<li><a href="#II_2_2">II.2.2. Spring integration</a></li>
							<li><a href="#II_2_3">II.2.3. Tomcat integration</a></li>
						</ul>
					</li>
				</ul>
			</li>
			<li><a href="#III">III. Running</a><br/>
				<ul>
					<li><a href="#III_1">III.1. Server side</a><br/>
						<ul>
							<li><a href="#III_1_1">III.1.1. Starting and stopping</a></li>
							<li><a href="#III_1_2">III.1.2. Diskspace usage</a></li>
						</ul>
					</li>
					<li><a href="#III_2">III.2. Client side</a><br/>
						<ul>
							<li><a href="#III_2_1">III.2.1. JNDI integration</a></li>
							<li><a href="#III_2_2">III.2.2. Command-line administration</a></li>
							<li><a href="#III_2_3">III.2.3. Command-line JMX console</a></li>
						</ul>
					</li>
				</ul>
			</li>
			<li><a href="#III">IV. Embedding a server instance</a><br/>
				<ul>
					<li><a href="#IV_1">IV.1. Spring integration</a></li>
					<li><a href="#IV_2">IV.2. Java integration</a></li>
				</ul>
			</li>
		</ul>
		
		<hr/>

<a name="I"></a>
		<h1>Installing</h1>
<a name="I_1"></a>
		<h2>Prerequisites</h2>
		<p>
			- FFMQ 4.x requires a JRE version 1.5 or above to run.<br/>
			- FFMQ 3.x requires a JRE version 1.4 or above to run.
		</p>
		<p>
			Default JVM parameters are set in the <i>bin/setenv.sh</i> script, which is read on startup.<br/>
			If you want to change things like the default FFMQ heap size this is the file to edit.
		</p>
<a name="I_2"></a>		
		<h2>Server side</h2>
<a name="I_2_1"></a>	
		<h3>Unpacking the distribution</h3>
		<p>
		  Download the latest <b>ffmqX-distribution-&lt;version&gt;-dist.zip</b> archive from the github <i>releases</i> page, and unpack it somewhere.<br/>
		  You will get the following directory tree :
		</p>
		  <ul>
			<li>bin/</li>
			<li>bridges/</li>
			<li>conf/</li>
			<li>conf/templates/</li>
			<li>data/</li>
			<li>destinations/</li>
			<li>docs/</li>
			<li>lib/</li>
			<li>logs/</li>
		  </ul>
<a name="I_2_2"></a>			  
		<h3>What's inside ?</h3>
		<ul>
		  <li>The bin/ directory contains shell scripts to start, stop and manage the FFMQ server.</li>
		  <li>The bridges/ directory holds JMS bridges descriptors loaded by the server on startup.</li>
		  <li>The conf/ directory contains various configuration files used by the server (see <i>Configuring</i> below). </li>
		  <li>The conf/templates/ directory contains default templates used to create new destinations (queues or topics).</li>
		  <li>The data/ directory (empty upon installation) is the default data folder where queues store/index files will be stored.</li>
		  <li>The destinations/ directory (empty upon installation) is the default descriptor folder where queues and topics descriptors will be created.</li>
		  <li>The docs/ directory contains these documentation files.</li>
		  <li>The lib/ directory contains all the jar files used by the server.</li>
		  <li>The logs/ directory will hold the server log files
		</ul>
<a name="I_3"></a>		
		<h2>Client side</h2>
		<p>
			On the client-side, you need the <i>ffmqX-core.jar</i> in your classpath. (plus the jms-api and commons-logging if you don't already have them)<br/>
			You will find those jars in the lib/ directory of the server package.<br/>
		</p>
		
<a name="II"></a>		
		<h1>Configuring</h1>
<a name="II_1"></a>			
		<h2>Server side</h2>
		<p>
			The main configuration file is <i>conf/ffmq-server.properties</i>.
</p><p> 
			This is a standard java properties file with key/pair values.<br/>
			See inside the distributed file for details, the various configuration settings are described in comments.<br/>
		</p>
<a name="II_1_1"></a>		
		<h3>Destination auto-creation</h3>
		<p>
		    FFMQ supports destination auto-creation based on templates.<br/>
			When enabled, on first usage of a non-existing queue (or topic), a matching template will be looked up in the 
			<i>templates.mapping</i> file and used to generate a valid queue (or topic) descriptor.
			This operation is transparent to clients and is useful to create auto-deployable queuers.<br/>
		</p>
<a name="II_1_2"></a>		
		<h3>Security</h3>
		<p>
			If the default XML-based security module is enabled in the main configuration file, users and permissions must 
			be described in the <i>security.xml</i> file.<br/>
			See syntax inside the distributed file. <i>Please note that security is *disabled* by default.</i>
		</p>
<a name="II_1_3"></a>		
		<h3>Templates</h3>
		<p>
			When a queue (or topic) is auto-created, the FFMQ engine looks up a template descriptor and 
			copy the template values into a real descriptor file (in the destinations/ folder)<br/>
			Here is a sample queue template descriptor (which is actually a properties file) :
		</p>
		<pre class="src">
#
#  This is the default template for queues
#
name = DEFAULT_QUEUE_TEMPLATE

persistentStore.initialBlockCount = 1000
persistentStore.autoExtendAmount  = 1000
persistentStore.maxBlockCount     = 10000
persistentStore.blockSize         = 4096
persistentStore.dataFolder        = ${FFMQ_BASE}/data
persistentStore.useJournal        = true

memoryStore.maxMessages           = 1000</pre>
		<p>
		Here is an exhaustive list of the supported properties and their default values :
		</p>
		<p><b>Common Properties</b></p>
		<table class="properties">
			<tr>
				<th>Property</th>
				<th>Default</th>
				<th>Usage</th>
			</tr>
			<tr>
			    <td>name</td>
				<td><i>No default</i></td>
				<td>The template name (as referenced in the <i>templates.mapping</i> file)</td>
			</tr>
			<tr>
				<td>persistentStore.initialBlockCount</td>
				<td>0</td>
				<td>Initial number of available blocks in the persistent store</td>
			</tr>
			<tr>
				<td>persistentStore.maxBlockCount</td>
				<td>0</td>
				<td>Maximum number of blocks in the persistent store. The store file may auto-extend up to this size (see <i>persistentStore.autoExtendAmount</i>).0 means no persistent storage.</td>
			</tr>
			<tr>
				<td>persistentStore.autoExtendAmount</td>
				<td>0</td>
				<td>Amount to grow by when auto-extending the store. The store is auto-extended when full.</td>
			</tr>
			<tr>
				<td>persistentStore.blockSize</td>
				<td>4096</td>
				<td>Size of a storage block. Minimum size is 1024 (1KB). Using bigger values may improve performance with large messages but will waste more disk space.</td>
			</tr>
			<tr>
				<td>persistentStore.dataFolder</td>
				<td>${FFMQ_BASE}/data</td>
				<td>Folder where to store persistent files for this destination. May be relative or absolute. May use system properties as variables.</td>
			</tr>
			<tr>
				<td>persistentStore.useJournal</td>
				<td>true</td>
				<td>Enables the use of a synced transaction log for the persistent store. Setting this to false disables transaction logs and filesystem syncing for this destination, which is a lot faster but no longer fail-safe.</td>
			</tr>
			<tr>
				<td>persistentStore.journal.dataFolder</td>
				<td><i>same as persistentStore.dataFolder</i></td>
				<td>Folder where to store journal files for this destination. May be relative or absolute. May use system properties as variables. This is useful if you want to place journal files on different hardware devices (or on faster devices like SSDs) to improve performance.</td>
			</tr>
			<tr>
				<td>persistentStore.journal.maxFileSize</td>
				<td>33554432</td>
				<td>Maximum size of a journal file before creating a new one. Default is 32MB. Actual journal files size may grow a little larger than this limit if it ends on a large transaction.</td>
			</tr>
			<tr>
				<td>persistentStore.journal.maxWriteBatchSize</td>
				<td>1000</td>
				<td>Maximum number of operations to process per asynchronous task. This setting has various implications on lock contention and commit barriers.</td>
			</tr>
			<tr>
				<td>persistentStore.journal.maxUnflushedJournalSize</td>
				<td>4194304</td>
				<td>Maximum size of journal data that may be bufferized in memory before starting to write to the actual journal file. Default is 4MB.</td>
			</tr>
			<tr>
				<td>persistentStore.journal.maxUncommittedStoreSize</td>
				<td>16777216</td>
				<td>Maximum size of store data that may be written to disk without syncing. Default is 16MB.</td>
			</tr>
			<tr>
				<td>persistentStore.journal.outputBufferSize</td>
				<td>16384</td>
				<td>Size of the I/O buffer to be used when writing to a journal file. Default is 16KB.</td>
			</tr>			
			<tr>
				<td>persistentStore.journal.preAllocateFiles</td>
				<td>true</td>
				<td>If true, journal files are pre-allocated to improve performance.</td>
			</tr>
			<tr>
				<td>persistentStore.syncMethod</td>
				<td>2</td>
				<td>
					Select the disk sync method to use :
					<ul>
						<li>1 : FileDescriptor.sync() </li>
						<li>2 : FileChannel.force(false)</li>
					</lu>
				</td>
			</tr>
			<tr>
				<td>memoryStore.maxMessages</td>
				<td>0</td>
				<td>Maximum number of non-persistent messages to store in memory.</td>
			</tr>
			<tr>
				<td>memoryStore.overflowToPersistent</td>
				<td>false</td>
				<td>Allow non-persistent messages to be stored in the persistent store if the memory store is full. 
				    Note that if you use this option, message ordering is no longer guaranteed.</td>
			</tr>
		</table>
		
		<p><b>Topic Properties</b></p>
		<table class="properties">
			<tr>
				<th>Property</th>
				<th>Default</th>
				<th>Usage</th>
			</tr>
			<tr>
			    <td>subscriberFailurePolicy</td>
				<td>1</td>
				<td>Define this topic behavior when an exception occurs while pushing a message to a subscriber. (Bit mask)
				<ul>
					<li><b>0</b> : Silently ignore errors</li>
					<li><b>1</b> : Log exception (server-side)</li>					
					<li><b>2</b> : Propagate exception to message producer</li>
					<li><b>3</b> : Do both (1 + 2)</li>
				</ul>
				</td>
			</tr>
			<tr>
			    <td>subscriberOverflowPolicy</td>
				<td>1</td>
				<td>Define this topic behavior when a subscriber queue is full. (Bit mask)
				<ul>
					<li><b>0</b> : Silently ignore and skip message</li>
					<li><b>1</b> : Log exception (server-side)</li>					
					<li><b>2</b> : Propagate exception to message producer.<br/> Note that enabling this feature in conjunction 
					with the client-side 'producer.retryOnQueueFull' property allows to throttle producer when a subscriber gets behind.</li>
					<li><b>3</b> : Do both (1 + 2)</li>
				</ul>
				</td>
			</tr>
			<tr>
			    <td>partitionsKeysToIndex</td>
				<td><i>Not set</i></td>
				<td>
					<p>
					<b>FFMQ 4.x only</b><br/>
					Allow to specify message headers on which to index topic subscribers that use a message selector. 
					</p>
					<p>
		                This can improve performance when using a partitioned topic pattern with a large number of subscribers 
		                (reducing dispatch complexity from O(n) to O(1)).
					</p>
					<p>
						Typical use-case : most topic subscribers have a message selector like :<br/>
					</p>
					<ul>
		                <li>(Consumer1) someHeader='key1'</li>
						<li>(Consumer2) someHeader='key2'</li>
						<li>...</li>
					</ul>
					<p>
						Indexing the subscribers on <i>'someHeader'</i> will improve dispatch performance.
					</p>
				</td>
			</tr>
		</table>
		<p>
			Notes :
		</p>
		<ul>
			<li>The syntax is the same for a queue or topic</li>
			<li>For a topic, the various parameters will be applied to the backing queues that hold the messages for each topic subscriber.</li>
			<li>There will be one temporary queue for each subscriber, so you need to take this into account when sizing your topic.</li>
			<li>The filename of a queue template must match the pattern <i>queueTemplate-*.properties</i> to be picked up.</li>
			<li>The filename of a topic template must match the pattern <i>topicTemplate-*.properties</i> to be picked up.</li>
		</ul>
<a name="II_1_4"></a>
		<h3>Destinations Descriptors</h3>
		<p>
			A destination descriptor is much like a template descriptor but it represents an actual existing destination.<br/>
			Descriptors are automatically created from a template or created on demand from the administration utility (see below).
			Syntax is the same as for a template, only the 'name' property refers to the actual destination name. 
		</p>
		<p>
			Notes :
		</p>
		<ul>
			<li>The syntax is the same for a queue or topic</li>
			<li>The filename of a queue definition must start with <i>queue-</i></li>
			<li>The filename of a topic definition must start with <i>topic-</i></li>
		</ul>
<a name="II_1_5"></a>		
		<h3>Command-line utility</h3>
		<p>
			There is a command-line utility to administrate the server. The utility must be configured 
			in the <i>conf/ffmq-admin-client.properties</i> properties file.<br/>
			See usage below.
		</p>

<a name="II_2"></a>			
		<h2>Client side</h2>
		<p>
			Here is the default implementation behavior regarding synchronous/asynchronous calls :<br/>
		</p>
		<ul>
			<li>Producing messages :
			<table class="properties">
				<tr>
					<td></td>
					<th>PERSISTENT</th>
					<th>NON-PERSISTENT</th>
				</tr>
				<tr>
					<th>TRANSACTED</th>
					<td><b>Async</b>*</td>
					<td><b>Async</b>*</td>
				</tr>
				<tr>
					<th>DUPS_OK_ACKNOWLEDGE</th>
					<td>Sync</td>
					<td><b>Async</b></td>
				</tr>
				<tr>
					<th>AUTO_ACKNOWLEDGE</th>
					<td>Sync</td>
					<td><b>Async</b></td>
				</tr>
				<tr>
					<th>CLIENT_ACKNOWLEDGE</th>
					<td>Sync</td>
					<td><b>Async</b></td>
				</tr>
			</table>
			<small>(* message dispatch is asynchronous but the commit operation is synchronous)</small>
			</li>
			<br/>
			<li>Consuming messages :
			<table class="properties">
				<tr>
					<td></td>
					<th>PERSISTENT</th>
					<th>NON-PERSISTENT</th>
				</tr>
				<tr>
					<th>TRANSACTED</th>
					<td>Sync</td>
					<td>Sync</td>
				</tr>
				<tr>
					<th>DUPS_OK_ACKNOWLEDGE</th>
					<td><b>Async</b></td>
					<td><b>Async</b></td>
				</tr>
				<tr>
					<th>AUTO_ACKNOWLEDGE</th>
					<td>Sync</td>
					<td>Sync</td>
				</tr>
				<tr>
					<th>CLIENT_ACKNOWLEDGE</th>
					<td>Sync</td>
					<td>Sync</td>
				</tr>
			</table>
			</li>
		</ul>
<a name="II_2_1"></a>		
		<h3>Client properties</h3>
		<p>
			The client-side driver looks for an optional resource file named <b>ffmqX.properties</b> in the classpath root.
			If you need to override some default settings, you can create this file and add it to your classpath.<br/>
			You can refer to <b>net/timewalker/ffmqX/ffmqX.properties</b> in <i>ffmq-core.jar</i> to
			see available properties and their default values :<br/>
		</p>
		<pre class="src">
# Time to wait for an anwser from the server (seconds)
transport.timeout=120

# Time to wait for a connection attempt (seconds)
transport.tcp.connectTimeout=30

# SSL options
transport.tcp.ssl.protocol=SSLv3
transport.tcp.ssl.ignoreCertificates=false

# Indicate if a consumer should send message acknowledgements synchronously or not
consumer.sendAcksAsync=true

# Indicate if a producer should retry if a target queue is full
producer.retryOnQueueFull=true

# Indicate how much time a producer should wait if a target queue is full (milliseconds)
# 0 = unlimited
producer.retryTimeout=30000</pre>
		<p>
			Note that in most cases you won't have to change any of these default settings.<br/>
		</p>
<a name="II_2_2"></a>		
		<h3>Spring integration</h3>
		<p>
			The FFMQ provider can be declared in spring like any other JMS client implementation.
		</p>
		<p>
			Here is how you would define a JMS connection factory :
		</p>
		<pre class="src">
&lt;bean id="JMSConnectionFactory" class="org.springframework.jndi.JndiObjectFactoryBean"&gt;
  &lt;property name="jndiName" value="factory/ConnectionFactory"/&gt;
  &lt;property name="jndiEnvironment"&gt;
        &lt;props&gt;
            &lt;prop key="java.naming.factory.initial"&gt;net.timewalker.ffmqX.jndi.FFMQInitialContextFactory&lt;/prop&gt;
            &lt;prop key="java.naming.provider.url"&gt;tcp://localhost:10002&lt;/prop&gt;
        &lt;/props&gt;
    &lt;/property&gt;
&lt;/bean&gt;</pre>
		<p>
			And here is how to obtain a a JMS destination bean from JNDI :
		</p>
		<pre class="src">
&lt;bean id="myJMSQueue" class="org.springframework.jndi.JndiObjectFactoryBean"&gt;
  &lt;property name="jndiName" value="queue/myJMSQueue"/&gt;
  &lt;property name="jndiEnvironment"&gt;
    &lt;props&gt;
      &lt;prop key="java.naming.factory.initial"&gt;net.timewalker.ffmqX.jndi.FFMQInitialContextFactory&lt;/prop&gt;
    &lt;/props&gt;
  &lt;/property&gt;
&lt;/bean&gt;</pre>
		<p>
			Then, you can declare standard spring JMS templates and listeners. <i>See the spring documentation for details.</i>
		</p>
		
<a name="II_2_3"></a>		
		<h3>Tomcat integration</h3>
		<p>
			The FFMQ provider and destination can be declared as a resource reference in a Tomcat &lt;Context&gt;.
		</p>
		<p>
			Here is an example definition :
		</p>
		<pre class="src">
&lt;Resource name="jms/ConnectionFactory"
  type="net.timewalker.ffmqX.jndi.FFMQConnectionFactory"
     factory="net.timewalker.ffmqX.jndi.JNDIObjectFactory"
     providerURL="tcp://localhost:10002"
     userName="test" password="test"
     /&gt;

&lt;Resource name="jms/myQueue"
  type="net.timewalker.ffmqX.common.destination.QueueRef"
  factory="net.timewalker.ffmqX.jndi.JNDIObjectFactory"
  queueName="MYQUEUE" /&gt;
  
  
&lt;Resource name="jms/mytopic"
  type="net.timewalker.ffmqX.common.destination.TopicRef"
  factory="net.timewalker.ffmqX.jndi.JNDIObjectFactory"
  queueName="MYTOPIC" /&gt;</pre>
<p>
And here is how to retrieve thoses resources using the tomcat default InitialContext :
</p>
<pre class="src">
InitialContext init = new InitialContext();
 
// Retrieving the connection factory
ConnectionFactory connectionFactory = (ConnectionFactory) init.lookup("java:comp/env/jms/ConnectionFactory");
        
// Retrieving the queue or topic reference          
Queue myQueue = (Queue)init.lookup("java:comp/env/jms/myQueue");
Topic myTopic = (Topic)init.lookup("java:comp/env/jms/myTopic");</pre>
<a name="III"></a>		
		<h1>Running</h1>
<a name="III_1"></a>			
		<h2>Server side</h2>
<a name="III_1_1"></a>
		<h3>Starting and stopping</h3>
		<p>
			- To start the server, use the <i>ffmq-server.bat</i> or <i>ffmq-server.sh</i> shell script in the server <i>bin/</i> directory.<br/>
			- To stop the server, use the <i>ffmq-shutdown.bat</i> or <i>ffmq-shutdown.sh</i> shell script in the server <i>bin/</i> directory.<br/>
			(If you want to remotely stop the server, you need to enable the administrative queues in the server configuration and use the <i>ffmq-remote-shutdown.bat</i> or <i>ffmq-remote-shutdown.sh</i> shell script)<br/>
		</p>
		<p> 
			Notes :
		</p>
		<ul>
			<li>The server will start a clean shutdown sequence if it receives a SIGTERM signal.</li>
			<li>It is not recommended to abruptly kill the server process as it will cause a recovery of all the active persistent storages on next restart.</li>
		</ul>
<a name="III_1_2"></a>		
		<h3>Diskspace usage</h3>
		<p>
			The persistent storage for a given destination is made of two or more files :
		</p>
		<ul>
			<li>A data file with extension .store (blockCount*blockSize bytes large), containing the messages</li>
			<li>An index file with extension .index (~ blockCount*13 bytes large) acting as an allocation table</li>
			<li>Up to two journal files (2*maxJournalSize bytes) during execution</li>
		</ul>
		<p>
			The required disk space for a queue is close to : <b style="white-space: nowrap">blockCount*(blockSize+13)+2*maxJournalSize</b><br/>
			Note that messages are splitted over complete blocks, which means you can store between : 
			<b>blockCount / (maxMessageSize modulo blockSize)</b> (worst case) and <b>blockCount</b> (best case)
			in a given message store.
		</p>
		
<a name="III_2"></a>		
		<h2>Client side</h2>
<a name="III_2_1"></a>		
		<h3>JNDI integration</h3>
		<p>
			The client implementation can be accessed through JNDI like any other standard JMS implementation.<br/>
			Here is the JNDI configuration to use :
		</p>
		<ul>
			<li><b>Naming Context Factory</b> : net.timewalker.ffmqX.jndi.FFMQInitialContextFactory</li>
			<li><b>Connection Factory JNDI Name</b> : factory/ConnectionFactory</li>
			<li><b>Provider URL</b> : tcp://&lt;hostname&gt;:10002</li>
		</ul>
		<p>
			Here is a sample source code if you need to do it programmatically :<br/>
		</p>
		<pre class="src">
// Create and initialize a JNDI context
Hashtable env = new Hashtable();
env.put(Context.INITIAL_CONTEXT_FACTORY, FFMQConstants.JNDI_CONTEXT_FACTORY);
env.put(Context.PROVIDER_URL, "tcp://localhost:10002");
Context context = new InitialContext(env);

// Lookup a connection factory in the context
ConnectionFactory connFactory = (ConnectionFactory)context.lookup(FFMQConstants.JNDI_CONNECTION_FACTORY_NAME);

// Obtain a JMS connection from the factory
Connection conn = connFactory.createConnection();
conn.start();
...</pre>
		<p>
			Note that to provide JMS 1.0.2 compliance, the following connection factories are also declared in the JNDI context :
		</p>
		<ul>
			<li>factory/QueueConnectionFactory</li>
			<li>factory/TopicConnectionFactory</li>
		</ul>
<a name="III_2_2"></a>			
		<h3>Command-line administration</h3>
		<p>
			The FFMQ server can be (remotely) administered through a command-line utility.<br/>
			To execute this utility, use the <i>ffmq-admin-client.bat</i> or <i>ffmq-admin-client.sh</i> shell script in the server <i>bin/</i> directory.<br/> 
			Executing the utility without command-line parameters will display usage information :
		</p>
		<pre class="src">
Command-line parameters
-------------------------
  -command <command>      : the command to execute (createQueue,createTopic,deleteQueue,deleteTopic,shutdown)
  -conf <propertiesFile>  : path to a properties file (optional)

All other variables should be passed as variable=value</pre>
		<p>
			When dealing with destinations you can pass all available properties (see 'Templates' above) with &lt;propertyName&gt;=&lt;value&gt;
		</p>
		<p>
			Examples :
		</p>
		<pre class="src">
# Create queue FOO with a non-persistent message capacity of 1000
ffmq-admin-client -command createQueue name=FOO memoryStore.maxMessages=1000
	
# Delete topic BAR
ffmq-admin-client -command deleteTopic name=BAR

# Ask the server to shutdown
ffmq-admin-client -command shutdown</pre>
		
<a name="III_2_3"></a>			
		<h3>Command-line JMX console</h3>
		<p>		
			The FFMQ server can be (remotely) monitored through JMX using generic tools or the provided command-line utility.<br/>
			To execute this utility, use the <i>ffmq-jmx-console.bat</i> or <i>ffmq-jmx-console.sh</i> shell script in the server <i>bin/</i> directory.<br/> 
		</p>
		
<a name="IV"></a>		
		<h1>Embedding a server instance</h1>
<a name="IV_1"></a>		
		<h2>Spring integration</h2>
		<p>
			You can start one (or more) engine instance in a given ApplicationContext, using a provided helper bean :
		</p>
		<pre class="src">net.timewalker.ffmqX.spring.FFMQServerBean</pre>
		<p>
			Here is a typical XML spring definition for this :
		</p>
		<pre class="src">
&lt;bean id="FFMQServer" class="net.timewalker.ffmqX.spring.FFMQServerBean" init-method="start" destroy-method="stop"&gt;
  &lt;property name="engineName" value="myEngine"/&gt;
  &lt;property name="configLocation" value="../conf/ffmq-server.properties"/&gt;
&lt;/bean&gt;</pre>
		<p>
		  Notes : 
		</p>
		<ul>
			<li>The <i>engineName</i> property value must be unique in a given VM</li>
			<li>The <i>configLocation</i> property supports the <i>'classpath:'</i> notation and must point to an existing properties file containing the server configuration</li>
			<li>This spring definition automatically calls the server start() and stop() methods on context init and close</li>
		</ul>		
<a name="IV_2"></a>		
	<h2>Java integration</h2>
	<p>
		A server instance can be created directly from Java code if needed.<br/>
		Here is an example source code :
	</p>
    <p>
    <div>
        <pre style='color:#000000;'>package net<span style='color:#808030; '>.</span>timewalker<span style='color:#808030; '>.</span>ffmqX<span style='color:#808030; '>.</span>sample<span style='color:#808030; '>.</span>embedded<span style='color:#800080; '>;</span>

<span style='color:#800000; font-weight:bold; '>import</span> java<span style='color:#808030; '>.</span>io<span style='color:#808030; '>.</span>FileInputStream<span style='color:#800080; '>;</span>
<span style='color:#800000; font-weight:bold; '>import</span> java<span style='color:#808030; '>.</span>util<span style='color:#808030; '>.</span>Properties<span style='color:#800080; '>;</span>

<span style='color:#800000; font-weight:bold; '>import</span> net<span style='color:#808030; '>.</span>timewalker<span style='color:#808030; '>.</span>ffmqX<span style='color:#808030; '>.</span>listeners<span style='color:#808030; '>.</span>ClientListener<span style='color:#800080; '>;</span>
<span style='color:#800000; font-weight:bold; '>import</span> net<span style='color:#808030; '>.</span>timewalker<span style='color:#808030; '>.</span>ffmqX<span style='color:#808030; '>.</span>listeners<span style='color:#808030; '>.</span>tcp<span style='color:#808030; '>.</span>io<span style='color:#808030; '>.</span>TcpListener<span style='color:#800080; '>;</span>
<span style='color:#800000; font-weight:bold; '>import</span> net<span style='color:#808030; '>.</span>timewalker<span style='color:#808030; '>.</span>ffmqX<span style='color:#808030; '>.</span>local<span style='color:#808030; '>.</span>FFMQEngine<span style='color:#800080; '>;</span>
<span style='color:#800000; font-weight:bold; '>import</span> net<span style='color:#808030; '>.</span>timewalker<span style='color:#808030; '>.</span>ffmqX<span style='color:#808030; '>.</span>management<span style='color:#808030; '>.</span>destination<span style='color:#808030; '>.</span>definition<span style='color:#808030; '>.</span>QueueDefinition<span style='color:#800080; '>;</span>
<span style='color:#800000; font-weight:bold; '>import</span> net<span style='color:#808030; '>.</span>timewalker<span style='color:#808030; '>.</span>ffmqX<span style='color:#808030; '>.</span>utils<span style='color:#808030; '>.</span>Settings<span style='color:#800080; '>;</span>

<span style='color:#3f5fbf; '>/**</span>
<span style='color:#3f5fbf; '>&#xa0;* Embedded FFMQ sample</span>
<span style='color:#3f5fbf; '>&#xa0;*/</span>
public class EmbeddedFFMQSample implements Runnable
<span style='color:#800080; '>{</span>
    private FFMQEngine engine<span style='color:#800080; '>;</span>
    
    <span style='color:#696969; '>/*</span>
<span style='color:#696969; '>&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;* (non-Javadoc)</span>
<span style='color:#696969; '>&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;* @see java.lang.Runnable#run()</span>
<span style='color:#696969; '>&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;*/</span>
    public <span style='color:#800000; font-weight:bold; '>void</span> run<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span>
    <span style='color:#800080; '>{</span>
        try
        <span style='color:#800080; '>{</span>
            <span style='color:#696969; '>// Create engine settings</span>
            Settings settings <span style='color:#808030; '>=</span> createEngineSettings<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            
            <span style='color:#696969; '>// Create the engine itself</span>
            engine <span style='color:#808030; '>=</span> new FFMQEngine<span style='color:#808030; '>(</span><span style='color:#800000; '>"</span><span style='color:#0000e6; '>myLocalEngineName</span><span style='color:#800000; '>"</span><span style='color:#808030; '>,</span> settings<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            <span style='color:#696969; '>//   -> myLocalEngineName will be the engine name.</span>
            <span style='color:#696969; '>//       - It should be unique in a given JVM</span>
            <span style='color:#696969; '>//       - This is the name to be used by local clients to establish</span>
            <span style='color:#696969; '>//         an internal JVM connection (high performance)</span>
            <span style='color:#696969; '>//         Use the following URL for clients :   vm://myLocalEngineName</span>
            <span style='color:#696969; '>//</span>
            
            <span style='color:#696969; '>// Deploy the engine</span>
            System<span style='color:#808030; '>.</span>out<span style='color:#808030; '>.</span>println<span style='color:#808030; '>(</span><span style='color:#800000; '>"</span><span style='color:#0000e6; '>Deploying engine : </span><span style='color:#800000; '>"</span><span style='color:#808030; '>+</span>engine<span style='color:#808030; '>.</span>getName<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            engine<span style='color:#808030; '>.</span>deploy<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            <span style='color:#696969; '>//  - The FFMQ engine is not functional until deployed.</span>
            <span style='color:#696969; '>//  - The deploy operation re-activates all persistent queues</span>
            <span style='color:#696969; '>//    and recovers them if the engine was not properly closed.</span>
            <span style='color:#696969; '>//    (May take some time for large queues)</span>

            <span style='color:#696969; '>// Adding a TCP based client listener</span>
            System<span style='color:#808030; '>.</span>out<span style='color:#808030; '>.</span>println<span style='color:#808030; '>(</span><span style='color:#800000; '>"</span><span style='color:#0000e6; '>Starting listener ...</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            ClientListener tcpListener <span style='color:#808030; '>=</span> new TcpListener<span style='color:#808030; '>(</span>engine<span style='color:#808030; '>,</span><span style='color:#800000; '>"</span><span style='color:#0000e6; '>0.0.0.0</span><span style='color:#800000; '>"</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>10002</span><span style='color:#808030; '>,</span>settings<span style='color:#808030; '>,</span>null<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            tcpListener<span style='color:#808030; '>.</span>start<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            
            <span style='color:#696969; '>// This is how you can programmatically define a new queue</span>
            <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>!</span>engine<span style='color:#808030; '>.</span>getDestinationDefinitionProvider<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>.</span>hasQueueDefinition<span style='color:#808030; '>(</span><span style='color:#800000; '>"</span><span style='color:#0000e6; '>foo</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>
            <span style='color:#800080; '>{</span>
                QueueDefinition queueDef <span style='color:#808030; '>=</span> new QueueDefinition<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                queueDef<span style='color:#808030; '>.</span>setName<span style='color:#808030; '>(</span><span style='color:#800000; '>"</span><span style='color:#0000e6; '>foo</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                queueDef<span style='color:#808030; '>.</span>setUseJournal<span style='color:#808030; '>(</span>false<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                queueDef<span style='color:#808030; '>.</span>setMaxNonPersistentMessages<span style='color:#808030; '>(</span><span style='color:#008c00; '>1000</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                queueDef<span style='color:#808030; '>.</span>check<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                engine<span style='color:#808030; '>.</span>createQueue<span style='color:#808030; '>(</span>queueDef<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            <span style='color:#800080; '>}</span>
            
            <span style='color:#696969; '>// You could also define a queue using some java Properties</span>
            <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>!</span>engine<span style='color:#808030; '>.</span>getDestinationDefinitionProvider<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>.</span>hasQueueDefinition<span style='color:#808030; '>(</span><span style='color:#800000; '>"</span><span style='color:#0000e6; '>foo2</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>
            <span style='color:#800080; '>{</span>
                Properties queueProps <span style='color:#808030; '>=</span> new Properties<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                queueProps<span style='color:#808030; '>.</span>put<span style='color:#808030; '>(</span><span style='color:#800000; '>"</span><span style='color:#0000e6; '>name</span><span style='color:#800000; '>"</span><span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '>foo2</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                queueProps<span style='color:#808030; '>.</span>put<span style='color:#808030; '>(</span><span style='color:#800000; '>"</span><span style='color:#0000e6; '>persistentStore.useJournal</span><span style='color:#800000; '>"</span><span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '>false</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                queueProps<span style='color:#808030; '>.</span>put<span style='color:#808030; '>(</span><span style='color:#800000; '>"</span><span style='color:#0000e6; '>memoryStore.maxMessages</span><span style='color:#800000; '>"</span><span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '>1000</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                QueueDefinition queueDef2 <span style='color:#808030; '>=</span> new QueueDefinition<span style='color:#808030; '>(</span>new Settings<span style='color:#808030; '>(</span>queueProps<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
                engine<span style='color:#808030; '>.</span>createQueue<span style='color:#808030; '>(</span>queueDef2<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            <span style='color:#800080; '>}</span>
            
            <span style='color:#696969; '>// Run for some time</span>
            System<span style='color:#808030; '>.</span>out<span style='color:#808030; '>.</span>println<span style='color:#808030; '>(</span><span style='color:#800000; '>"</span><span style='color:#0000e6; '>Running ...</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            Thread<span style='color:#808030; '>.</span>sleep<span style='color:#808030; '>(</span><span style='color:#008c00; '>30</span><span style='color:#808030; '>*</span><span style='color:#008c00; '>1000</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            
            <span style='color:#696969; '>// Stopping the listener</span>
            System<span style='color:#808030; '>.</span>out<span style='color:#808030; '>.</span>println<span style='color:#808030; '>(</span><span style='color:#800000; '>"</span><span style='color:#0000e6; '>Stopping listener ...</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            tcpListener<span style='color:#808030; '>.</span>stop<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            
            <span style='color:#696969; '>// Undeploy the engine</span>
            System<span style='color:#808030; '>.</span>out<span style='color:#808030; '>.</span>println<span style='color:#808030; '>(</span><span style='color:#800000; '>"</span><span style='color:#0000e6; '>Undeploying engine ...</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            engine<span style='color:#808030; '>.</span>undeploy<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            <span style='color:#696969; '>//   - It is important to properly shutdown the engine </span>
            <span style='color:#696969; '>//     before stopping the JVM to make sure current transactions </span>
            <span style='color:#696969; '>//     are nicely completed and storages properly closed.</span>
            
            System<span style='color:#808030; '>.</span>out<span style='color:#808030; '>.</span>println<span style='color:#808030; '>(</span><span style='color:#800000; '>"</span><span style='color:#0000e6; '>Done.</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        <span style='color:#800080; '>}</span>
        catch <span style='color:#808030; '>(</span>Exception e<span style='color:#808030; '>)</span>
        <span style='color:#800080; '>{</span>
            <span style='color:#696969; '>// Oops</span>
            e<span style='color:#808030; '>.</span>printStackTrace<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        <span style='color:#800080; '>}</span>
    <span style='color:#800080; '>}</span>
    
    private Settings createEngineSettings<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span>
    <span style='color:#800080; '>{</span>
        <span style='color:#696969; '>// Various ways of creating engine settings</span>
        
        <span style='color:#696969; '>// 1 - From a properties file</span>
        Properties externalProperties <span style='color:#808030; '>=</span> new Properties<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        try
        <span style='color:#800080; '>{</span>
            FileInputStream in <span style='color:#808030; '>=</span> new FileInputStream<span style='color:#808030; '>(</span><span style='color:#800000; '>"</span><span style='color:#0000e6; '>../conf/ffmq-server.properties</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            externalProperties<span style='color:#808030; '>.</span>load<span style='color:#808030; '>(</span>in<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
            in<span style='color:#808030; '>.</span>close<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        <span style='color:#800080; '>}</span>
        catch <span style='color:#808030; '>(</span>Exception e<span style='color:#808030; '>)</span>
        <span style='color:#800080; '>{</span>
            throw new RuntimeException<span style='color:#808030; '>(</span><span style='color:#800000; '>"</span><span style='color:#0000e6; '>Cannot load external properties</span><span style='color:#800000; '>"</span><span style='color:#808030; '>,</span>e<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        <span style='color:#800080; '>}</span>
        Settings settings <span style='color:#808030; '>=</span> new Settings<span style='color:#808030; '>(</span>externalProperties<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        
        <span style='color:#696969; '>// 2 - Explicit Java code</span>
<span style='color:#696969; '>//        Settings settings = new Settings();</span>
<span style='color:#696969; '>//        </span>
<span style='color:#696969; '>//        settings.setStringProperty(FFMQCoreSettings.DESTINATION_DEFINITIONS_DIR, ".");</span>
<span style='color:#696969; '>//        settings.setStringProperty(FFMQCoreSettings.BRIDGE_DEFINITIONS_DIR, ".");</span>
<span style='color:#696969; '>//        settings.setStringProperty(FFMQCoreSettings.TEMPLATES_DIR, ".");</span>
<span style='color:#696969; '>//        settings.setStringProperty(FFMQCoreSettings.DEFAULT_DATA_DIR, ".");</span>
<span style='color:#696969; '>//        ...</span>
        
        <span style='color:#800000; font-weight:bold; '>return</span> settings<span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    
    <span style='color:#3f5fbf; '>/**</span>
<span style='color:#3f5fbf; '>&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;* </span><span style='color:#7f9fbf; font-weight:bold; '>@param</span><span style='color:#3f5fbf; '> args</span>
<span style='color:#3f5fbf; '>&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;*/</span>
    public <span style='color:#800000; font-weight:bold; '>static</span> <span style='color:#800000; font-weight:bold; '>void</span> <span style='color:#400000; '>main</span><span style='color:#808030; '>(</span><span style='color:#603000; '>String</span><span style='color:#808030; '>[</span><span style='color:#808030; '>]</span> args<span style='color:#808030; '>)</span>
    <span style='color:#800080; '>{</span>
        System<span style='color:#808030; '>.</span>setProperty<span style='color:#808030; '>(</span><span style='color:#800000; '>"</span><span style='color:#0000e6; '>FFMQ_BASE</span><span style='color:#800000; '>"</span><span style='color:#808030; '>,</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '>..</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        
        new EmbeddedFFMQSample<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>.</span>run<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
<span style='color:#800080; '>}</span>
    </div>
    </p>

        <a href="index.html#doc">&lt;&lt; Back to index</a>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">FFMQ maintained by <a href="https://github.com/timewalker74">timewalker74</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

  </body>
</html>
